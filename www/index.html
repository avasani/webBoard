<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>getUserMedia Example</title>
    <meta name="description" content="WebRTC Simple example" />
    <meta name="author" content="Ido Green | greenido.wordpress.com">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <meta name="keywords" content="WebRTC, HTML5, JavaScript, Hack, Ido Green" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <base target="_blank">

    <style>
      video {
        height: 25em;
        position: relative;
        left: 15%;
      }

      #video-space {
        padding: 1em;
        background-color: rgba(70, 70, 6, 0.55);
        border-radius: 25px;
      }
      ul {
        padding: 2em;
        font-family: sans-serif;
        font-size: 120%;
        line-height:160%;
        background-color: lightgray;
        border-radius: 25px
      }
    </style>
  </head>

  <body>

    <h1>getUserMexcdia API Example</h1>
	<div>
<canvas id="canvas" width="600" height="600" style="border:solid black 1px;">
  Your browser does not support canvas element.
</canvas>

<canvas id="canvas_1" width="600" height="600" style="border:solid black 1px;">
  Your browser does not support canvas element.
</canvas>

<br>
<button onclick="startup()">Initialize</button>
<br>
Log: <pre id="log" style="border: 1px solid #ccc;"></pre>
</div>

    <script>
  
function startup() {
  var el = document.getElementsByTagName("canvas")[0];
  el.addEventListener("touchstart", handleStart, false);
  el.addEventListener("touchend", handleEnd, false);
  el.addEventListener("touchcancel", handleCancel, false);
  el.addEventListener("touchleave", handleEnd, false);
  el.addEventListener("touchmove", handleMove, false);
  post_data(2,1);
  setInterval(print_in_other_canvas, 50);
  log("initialized.");
}

var ongoingTouches = new Array();

function print_in_other_canvas() {
  log("1111111111111111111111111");
  $.ajax({
      type: 'GET',
      url: '/data',
      async : 'false',
      dataType : 'json',
            cache: false,
      timeout : 5000,
      success : success_cb,
      error: function() {
        log("ee");
      }
   }).done();
}

function handleStart(evt) {
  evt.preventDefault();
  log("touchstart.");
  var el = document.getElementsByTagName("canvas")[0];
  var ctx = el.getContext("2d");
  var touches = evt.changedTouches;
        
  for (var i=0; i < touches.length; i++) {
    log("touchstart:"+i+"...");
    ongoingTouches.push(copyTouch(touches[i]));
    var color = colorForTouch(touches[i]);
    ctx.beginPath();
    ctx.arc(touches[i].pageX, touches[i].pageY, 4, 0,2*Math.PI, false);  // a circle at the start
    ctx.fillStyle = color;
    ctx.fill();
    log("touchstart:"+i+".");
  }
}

function post_data(x,y, tx, ty) {

	log("?>>>>>"+x+y);
	var data1 = new Object();
	data1.x = x;
	data1.y = y;
  data1.tx = tx;
  data1.ty = ty;
	log(JSON.stringify(data1));

	$.ajax({
			type: 'POST',
			url: '/data',
			data: JSON.stringify(data1),
			async : 'true',
			dataType : 'json',
			contentType : 'application/json',
			timeout : 5000,
 			success: function() {
				log("sent!!");
			},
			error: function(err) {
				log("------"+JSON.stringify(err));
			},
		}).done();


}


var x,y, tx, ty;
function success_cb(data)
{
  try {
  var data1 = new Object();
	x = data.x;
	y = data.y;
  tx = data.tx;
  ty = data.ty;
	log("Got the x = " + x + " y = " + y + " tx = " + tx + " ty = " + ty);
  var el1 = document.getElementsByTagName("canvas")[1];
  var ctx1 = el1.getContext("2d");

  ctx1.beginPath();
  log("ctx1.moveTo("+x+", "+y+");");

  ctx1.moveTo(x, y);
  log("ctx1.lineTo("+tx+", "+ty+");");
  ctx1.lineTo(tx, ty);
  ctx1.lineWidth = 4;
  ctx1.strokeStyle = color;
  ctx1.stroke();
  } catch (err) {

  }
}

function handleMove(evt) {
  evt.preventDefault();
  var el = document.getElementsByTagName("canvas")[0];
  var ctx = el.getContext("2d");
  var touches = evt.changedTouches;

  for (var i=0; i < touches.length; i++) {
    var color = colorForTouch(touches[i]);
    var idx = ongoingTouchIndexById(touches[i].identifier);

    if(idx >= 0) {
      log("continuing touch "+idx);
      ctx.beginPath();
      log("ctx.moveTo("+ongoingTouches[idx].pageX+", "+ongoingTouches[idx].pageY+");");
      ctx.moveTo(ongoingTouches[idx].pageX, ongoingTouches[idx].pageY);
      log("ctx.lineTo("+touches[i].pageX+", "+touches[i].pageY+");");

      post_data(ongoingTouches[idx].pageX, ongoingTouches[idx].pageY, touches[i].pageX, touches[i].pageY);

      ctx.lineTo(touches[i].pageX, touches[i].pageY);
      ctx.lineWidth = 4;
      ctx.strokeStyle = color;
      ctx.stroke();
      ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
      log(".");
    } else {
      log("can't figure out which touch to continue");
    }
  }
}

function handleEnd(evt) {
  evt.preventDefault();
  log("touchend/touchleave.");
  var el = document.getElementsByTagName("canvas")[0];
  var ctx = el.getContext("2d");
  var touches = evt.changedTouches;

  for (var i=0; i < touches.length; i++) {
    var color = colorForTouch(touches[i]);
    var idx = ongoingTouchIndexById(touches[i].identifier);

    if(idx >= 0) {
      ctx.lineWidth = 4;
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(ongoingTouches[idx].pageX, ongoingTouches[idx].pageY);
      ctx.lineTo(touches[i].pageX, touches[i].pageY);
      ctx.fillRect(touches[i].pageX-4, touches[i].pageY-4, 8, 8);  // and a square at the end
      ongoingTouches.splice(idx, 1);  // remove it; we're done
    } else {
      log("can't figure out which touch to end");
    }
  }
}

function handleCancel(evt) {
  evt.preventDefault();
  log("touchcancel.");
  var touches = evt.changedTouches;
  
  for (var i=0; i < touches.length; i++) {
    ongoingTouches.splice(i, 1);  // remove it; we're done
  }
}

function colorForTouch(touch) {
  var r = touch.identifier % 16;
  var g = Math.floor(touch.identifier / 3) % 16;
  var b = Math.floor(touch.identifier / 7) % 16;
  r = r.toString(16); // make it a hex digit
  g = g.toString(16); // make it a hex digit
  b = b.toString(16); // make it a hex digit
  var color = "#" + r + g + b;
  log("color for touch with identifier " + touch.identifier + " = " + color);
  return color;
}

function copyTouch(touch) {
  return { identifier: touch.identifier, pageX: touch.pageX, pageY: touch.pageY };
}

function ongoingTouchIndexById(idToFind) {
  for (var i=0; i < ongoingTouches.length; i++) {
    var id = ongoingTouches[i].identifier;
    
    if (id == idToFind) {
      return i;
    }
  }
  return -1;    // not found
}

function log(msg) {
  var p = document.getElementById('log');
  p.innerHTML = msg + "\n" + p.innerHTML;
}

    </script>
</body>
</html>
