<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weboard</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <script type="text/javascript" src="js/respond.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script src="https://www.webrtc-experiment.com/firebase.js"></script>
    <script type="text/javascript" src="js/meeting.js"></script>
    <script type="text/javascript" src="js/webboard.js"></script>
    <style type="text/css">
    video {
        padding: 10px;
    }
    </style>

</head>

<body>

    <div class="container">
        <div id="getUsername" class="row" style="margin-top:5px">
        </div>
        <div class="row" style="margin-top:20px">
            <div id="uploaddiv" class="col-xs-12 col-sm-12 col-md-12">
                <form class="form-inline" id="uploadForm" enctype="multipart/form-data" action="/upload" method="post">
                    <!-- <input type="file" id="userPhotoInput" name="displayImage" /> -->
                    <div class="form-group">
                        <input class="btn btn-default" type="file" id="upload" name="upload" />
                    </div>
                    <div class="form-group">
                        <input class="btn btn-default" type="submit" value="Upload">
                    </div>
                </form>
                <!-- <div id="loading">Loading...</div> -->
            </div>
        </div>
        <div class="row" style="margin-top:20px">
            <div id="instpptdiv" class="col-xs-12 col-sm-10 col-md-9">
                <canvas id="serverCanvas" width="800" height="500" style="border:2px solid #bdc3c7;"></canvas>
                <br/>
                <div style="width:800px">
                    <button class="btn btn-default" id="previous">Previous</button>
                    <button class="btn btn-default" id="next" style="float:right;">Next</button>
                </div>
            </div>
            <div id="instvideodiv" class="col-xs-12 col-sm-2 col-md-3">
                <button class="btn btn-default" style="margin-bottom:5px;" id="setup-new-live-class">Setup New Live Session</button>
                <section id="videos-container">
            </div>
        </div>
        <div class="row" style="margin-top:20px">
            <section id="videos-child-container"></section>
        </div>

    </div>
    <!-- javascript -->
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>


</body>
<script type="text/javascript">
var hash = window.location.hash.replace('#', '');
var meeting = new Meeting(hash);

var videoContainer = document.getElementById('videos-container');
var videoChildContainer = document.getElementById('videos-child-container');

// on getting media stream
meeting.onaddstream = function(e) {
    e.video.width = 200;
    e.video.height = 200;
    if (e.video.id == "self") {
        videoContainer.appendChild(e.video);
        $('#videos-container video').attr('controls', false);
        $('#videos-container video').css({
            "border-color": "#bdc3c7",
            "border-width": "1px",
            "border-style": "solid",
            "width": "260px",
            "height": "204px"
        });
    } else {
        e.video.float = "left";
        e.video.control
        videoChildContainer.appendChild(e.video);
        $('#videos-child-container video').css("padding", "10");
        $('#videos-child-container video').attr('controls', false);
    }

};

// using firebase for signaling
meeting.firebase = 'rtcweb';

// if someone leaves; just remove his video
meeting.onuserleft = function(userid) {
    var video = document.getElementById(userid);
    if (video) video.parentNode.removeChild(video);
};

var is_started = false;

function successCb(data) {
    console.log(JSON.stringify(data));
    is_started = true;
}

function errorCb(err) {
    console.log(err);
}
document.getElementById('setup-new-live-class').onclick = function() {
    // setup new meeting room
    if (is_started) {
        console.log("Stopping now");
        $("#setup-new-live-class").text("Start Again");
        /* TODO: Stop code */
        return;
    }
    meeting.setup('Class-ASU');
    this.disabled = true;
    var postData = new Object();
    postData.sessionURL = location.href;
    //ajaxPOST("sessionURL", JSON.stringify(postData), successCb, errorCb);

    $("#setup-new-live-class").text("Stop Session");
};
</script>
<script type="text/javascript">
var pathOfImages;
var counter;
var check = true;
var server_started = false;

function waitForPath() {
    $.ajax({
        type: 'GET',
        url: 'dirPath',
        dataType: 'json',
        contentType: 'application/json',
        success: function(data) {
            if (data.path == null && data.path == "") {
                console.log("Path not found!!");
                //setInterval(waitForPath, 1000);
            } else {
                console.log(">>>>>>>>>Got Path " + data.path);
                check = false;
                pathOfImages = data.path;
                counter = data.count;
                displayInCanavs();
                if (!server_started) {
                    init_server('serverCanvas');
                    server_started = true;
                }
            }
        },
        error: function(err) {
            console.log("Err" + err);
        }
    }).done();
}

var path;
$('#formSubmit').on('click', function() {
    var fd = new FormData();
    fd.append("upload", document.getElementById('upload').files[0]);
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/upload", true);
    xhr.setRequestHeader("Content-Type", "application/octet-stream");
    xhr.upload.addEventListener('loadstart', onloadstartHandler, false);
    xhr.upload.addEventListener('progress', onprogressHandler, false);
    //xhr.addEventListener('load', uploadComplete, false);
    xhr.upload.addEventListener('load', onloadHandler, false);
    xhr.addEventListener('readystatechange', onreadystatechangeHandler, false);

    // ajax.onreadystatechange = function() {
    //     console.log("$$$$$$$$$$$ Ready Statess" + ajax.readyState);
    //     if (ajax.readyState == 4 && (ajax.status == 200)) {
    //         console.log("ready" + JSON.stringify(ajax.responseText));
    //     }
    // };
    xhr.send(fd);
    dummy();
});

// Handle the start of the transmission
function onloadstartHandler(evt) {
    //var div = document.getElementById('upload-status');
    //div.innerHTML = upgrade_target + ' upload started!';
    console.log("onloadstartHandler");
}

// Handle the end of the transmission
function onloadHandler(evt) {
    //var div = document.getElementById('progress');
    // div.innerHTML = 'Progress: 100%';

    // div = document.getElementById('upload-status');
    // div.innerHTML = upgrade_target + ' upload successful!';
    console.log("onloadHandler");
}

// Handle the progress
function onprogressHandler(evt) {
    // var div = document.getElementById('progress');
    // var percent = (evt.loaded / evt.total * 100).toFixed(0);
    // div.innerHTML = 'Progress: ' + percent + '%';
    console.log("onprogressHandler");
}


function onreadystatechangeHandler(evt) {
    var status = null;

    try {
        status = evt.target.status;
    } catch (e) {
        return;
    }

    if (status == '200' && evt.target.responseText) {
        var obj = jQuery.parseJSON(evt.target.responseText);
        try {
            var result = document.getElementById('result');
            if (typeof obj.success === 'undefined')
                result.innerHTML = 'Upgrade status: <strong style="color:red;">Failed</strong>' +
                '<br><br>' +
                'Note: Upgrade can fail even after upload is successful.' + '<br>' +
                'One reason for upgrade failure is when the image uploaded is not of correct format/size.';
            else
                result.innerHTML = 'Upgrade status: <strong style="color:green;">Success</strong>';
        } catch (err) {}
    }
}


var timeout;

function dummy() {
    timeout = setTimeout(function() {
        clearTimeout(timeout);
        waitForPath();
        if (check)
            dummy();
    }, 3000);
}
window.onload = function() {
    dummy();
    //window.location.assign("/");
    getUser();
};

function getUser() {
    ajaxGET('/getUsername', function(data) {
            $('#getUsername').css({
                "float": "right"
            });
            $('#getUsername').text("Hello " + data.user.fname + " " + data.user.lname + "  ");
            var r = $('<input type="button" class="btn btn-default" id="logout" value="Logout"/>');
            $('#getUsername').append(r);
            $('#logout').on('click', function() {
                console.log("Hello logout");
                ajaxGET('/logout', function(data) {
                    if (data.success === 0) {
                        console.log("Got Response");
                        window.location = "/";
                    }
                }, function(err) {
                    console.log("jdvnfjvnevjnvj.");
                    window.location = "/";
                });
            });

        }),
        function(err) {
            console.log("Error in retreiving Data.");
        }
}

function uploadComplete(evt) {
    /* This event is raised when the server send back a response */
    console.log("Reached in complete");
    alert(evt.target.responseText);
}



var myCanvas = document.getElementById('serverCanvas');
var instDiv = document.getElementById('instpptdiv');
var contextSrv = document.getElementById('serverCanvas').getContext("2d");
var img = new Image();
var current = 0;
var slideUrl = new Array;

function displayInCanavs() {
    console.log(counter);

    for (var i = 0; i < counter; i++) {
        slideUrl.push("./images/" + pathOfImages + "/out" + (i + 1) + ".jpeg");
        console.log(slideUrl[i]);
    }
    img.src = slideUrl[0];
    addSlideByServer(slideUrl[current]);
}

$(document).ready(function() {

    img.onload = function() {
        console.log("width" + img.width + "height" + img.height);
        document.getElementById('serverCanvas').width = 0;
        contextSrv.clearRect(0, 0, 800, 500);
        document.getElementById('serverCanvas').width = 800;
        contextSrv.drawImage(img, 0, 0, 800, 500);
    }


    $('#next').click(function() {
        console.log("next" + current);
        if (current == counter - 1) {
            current = counter - 1;
        } else {
            current++;
        }
        contextSrv.clearRect(0, 0, 800, 500);
        img.src = null;
        img.src = slideUrl[current];
        addSlideByServer(slideUrl[current]);
    });
    $('#previous').click(function() {
        console.log("previous" + current);
        if (current == 0) {
            current = 0;
        } else {
            current--;
        }
        img.src = slideUrl[current];
        addSlideByServer(slideUrl[current]);
    });
});
</script>

</html>
